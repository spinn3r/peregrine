#!/bin/sh

BRANCH=burton-bench
DIR=/root/peregrine
LOGDIR=/var/log
MAX_MEMORY=256M
OPEN_FILES=16384

###
# run the given command but print what we're about to run... 
run() {

    echo $@
    $@
    result=$?
    return $result

}

start() {

    for host in `cat conf/peregrine.hosts`; do
        hostname=$(echo $host|grep -Eo '^[^:]+')
        run ssh root@$hostname "cd $DIR && rm -rf logs && mkdir -p logs && ./bin/workerd --host=$host" 
    done

}

stop() {

    for host in `cat conf/peregrine.hosts | grep -Eo '^[^:]+' | sort | uniq`; do
        run ssh root@$host "pgrep -f peregrine.worker.Main | xargs kill"
    done

}

prep() {

    for host in `cat conf/peregrine.hosts | grep -Eo '^[^:]+' | sort | uniq`; do
        run ssh root@$host "cd $DIR && hg pull -u && ant clean jar" 
    done

}

command=$1

case $command in

    prep)
        prep
        ;;

    start)
        start
        ;;

    stop)
        stop
        ;;

    *)
        echo "ERROR: unknown command: $command" 
        exit 1
        ;;

esac
