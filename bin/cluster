#!/bin/sh

BRANCH=burton-bench
DIR=/root/peregrine
LOGDIR=/var/log
MAX_MEMORY=256M
OPEN_FILES=16384

start() {

    for host in `cat conf/peregrine.hosts`; do

        echo $host

        hostname=$(echo $host|grep -Eo '^[^:]+')

        echo $hostname

        #FIXME: waitfor the daemon to starup.
        #ssh root@$hostname "cd $DIR && export HOSTNAME && nohup ./bin/jexec peregrine.worker.Main -h=$host > $LOGDIR/peregrine-$host.log 2> $LOGDIR/peregrine-$host.err &" 

        set -x

        #ssh -v root@$hostname "cd $DIR && nohup ./bin/workerd --host=$host > $LOGDIR/peregrine-$host.log 2> $LOGDIR/peregrine-$host.err & " 
        #ssh root@$hostname "cd $DIR && nohup ./bin/workerd --host=$host " 

        ssh root@$hostname "cd $DIR && ./bin/workerd --host=$host" 

        set +x

    done

}

stop() {

    for host in `cat conf/peregrine.hosts | grep -Eo '^[^:]+' | sort | uniq`; do

        set -x
        ssh root@$host "pgrep -f peregrine.worker.Main | xargs kill"
        set +x

    done

}

prep() {

    for host in `cat conf/peregrine.hosts | grep -Eo '^[^:]+' | sort | uniq`; do

        set -x
        ssh root@$host "cd $DIR && hg pull -u && ant clean jar" 
        set +x

    done

}

command=$1

case $command in

    prep)
        prep
        ;;

    start)
        start
        ;;

    stop)
        stop
        ;;

esac
