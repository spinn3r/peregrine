#!/bin/sh

MAX=40

BRANCH=default

SCRATCH=/tmp/integration/peregrine
TEST_LOGS=/var/lib/integration/peregrine

if [ ! -d $SCRATCH ]; then

    echo "Pulling and installing new scratch repo... "

    #FIXME: read the repo URL from hg... 
    hg clone https://burtonator:redapplekittycat@bitbucket.org/burtonator/peregrine $SCRATCH

fi

mkdir -p $SCRATCH/target

set -e

cd $SCRATCH 
hg pull -u

for changeset in `hg log -b default --limit $MAX |grep -i changeset |grep -Eo '[a-zA-z0-9:]+$' |grep -Eo '^[0-9]+'`; do 
    
    echo "Working with changeset $changeset"

    cd $SCRATCH 
    
    hg update -r $changeset

    ant clean 

    mkdir -p $TEST_LOGS/$changeset/

    ant test 2> /dev/stdout | tee $TEST_LOGS/$changeset/test.log

done

# FIXME: now clean up older reports ... 