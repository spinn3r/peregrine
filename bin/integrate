#!/bin/sh

MAX=20

BRANCH=default

SCRATCH=/tmp/integration/peregrine

if [ ! -d $SCRATCH ]; then

    echo "Pulling and installing new scratch repo... "

    #FIXME: read the repo URL from hg... 
    hg clone https://burtonator:redapplekittycat@bitbucket.org/burtonator/peregrine $SCRATCH

fi

mkdir -p $SCRATCH/target

set -e

cd $SCRATCH 
hg pull -u

for changeset in `hg log -b default --limit $MAX |grep -i changeset |grep -Eo '[a-zA-z0-9:]+$' |grep -Eo '^[0-9]+'`; do 
    
    echo $changeset

    cd $SCRATCH 
    
    hg update -r $changeset
    
    mkdir -p $SCRATCH/target/$changeset

    ant clean 
    ant test | tee > $SCRATCH/target/$changeset/test.log

done
