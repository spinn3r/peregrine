#!/bin/sh

start() {

    # first check if we are already running ...
    ./bin/jexec peregrine.worker.WaitForDaemon 2> /dev/null $args 
    result=$?

    # yup... we're up and running, so stop and return.
    if [ "$result" = "0" ]; then
        exit 0
    fi

    export MAX_DIRECT_MEMORY=$(./bin/jexec peregrine.worker.GetMaxDirectMemory $args 2> /dev/null)
    result=$?

    if [ "$result" != "0" ]; then
        echo "Unable to determine max memory" 
        exit $result
    fi

    # no, we weren't running, so go ahead and startup.
    ./bin/jexec peregrine.worker.Main $args < /dev/null > /dev/null 2> /dev/null &
    pid=$!

    # now that we started the daemon, wait for it to startup... if it starts, great,
    # if not fail.
    ./bin/jexec peregrine.worker.WaitForDaemon --pid=$pid $args 2> /dev/null 
    result=$?

    exit $result

}

stop() {
    
    ./bin/jexec peregrine.worker.Main $args 2> /dev/null
    result=$?

    if [ "$result" != "0" ]; then
        echo "FAILED to stop daemon"
    fi

    exit $result

}

args=$@
shift $(expr $# - 1)
command=$1

case $command in

    start)
        start
        ;;

    stop)
        stop
        ;;

    restart)
        stop
        start
        ;;

    *)
        echo "ERROR: unknown command: $command" 
        exit 1
        ;;

esac
